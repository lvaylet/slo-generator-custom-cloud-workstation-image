name: Build image and push to Artifact Registry using Cloud Build

on:
  push:
    branches:
    - main

jobs:
  cloud-build:
    name: Setup, Build, and Push with Cloud Build
    runs-on: ubuntu-latest

    # Add "id-token" with the intended permissions.
    permissions:
      contents: read
      id-token: write

    steps:
    # checkout MUST come before auth
    - name: Checkout
      id: Checkout
      uses: actions/checkout@v3

    # Configure Workload Identity Federation and generate an access token.
    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v0
      with:
        workload_identity_provider: projects/803140796435/locations/global/workloadIdentityPools/github-identity-pool/providers/github-identity-provider
        service_account: cloud-builder@slo-generator-demo.iam.gserviceaccount.com

    - name: Set up Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v1
    
    - name: Confirm we are indeed authenticated
      run: gcloud auth list

    - name: Build image and push to Artifact Registry
      run: |-
        gcloud auth list; \
        gcloud builds submit \
          --quiet \
          --tag "europe-west9-docker.pkg.dev/slo-generator-demo/docker/code-oss-for-slo-generator:$GITHUB_SHA"
